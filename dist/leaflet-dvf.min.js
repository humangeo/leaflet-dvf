/*
 Leaflet Data Visualization Framework, a JavaScript library for creating thematic maps using Leaflet
 (c) 2013, Scott Fairgrieve, HumanGeo
*/
var L=L||{};L.BarMarker=L.Path.extend({initialize:function(centerLatLng,options){L.Path.prototype.initialize.call(this,options),this._centerLatLng=centerLatLng},options:{fill:!0,width:2,maxHeight:10,position:{x:0,y:0},weight:1,color:"#000",opacity:1},setLatLng:function(latlng){return this._centerLatLng=latlng,this.redraw()},projectLatlngs:function(){this._point=this._map.latLngToLayerPoint(this._centerLatLng),this._points=this._getPoints()},getBounds:function(){var map=this._map,radiusX=this.options.radiusX||this.options.radius,radiusY=this.options.radiusY||this.options.radius,deltaX=radiusX*Math.cos(Math.PI/4),deltaY=radiusY*Math.sin(Math.PI/4),point=map.project(this._centerLatLng),swPoint=new L.Point(point.x-deltaX,point.y+deltaY),nePoint=new L.Point(point.x+deltaX,point.y-deltaY),sw=map.unproject(swPoint),ne=map.unproject(nePoint);return new L.LatLngBounds(sw,ne)},getLatLng:function(){return this._centerLatlng},getPathString:function(){return""+new L.SVGPathBuilder(this._points)},_getPoints:function(){var sePoint,nePoint,nwPoint,swPoint,points=[],startX=this._point.x+this.options.position.x,startY=this._point.y+this.options.position.y,halfWidth=this.options.width/2,height=this.options.value/this.options.maxValue*this.options.maxHeight;return sePoint=new L.Point(startX+halfWidth,startY),nePoint=new L.Point(startX+halfWidth,startY-height),nwPoint=new L.Point(startX-halfWidth,startY-height),swPoint=new L.Point(startX-halfWidth,startY),points=[sePoint,nePoint,nwPoint,swPoint]}}),L.barMarker=function(centerLatLng,options){return new L.BarMarker(centerLatLng,options)},L.ChartMarker=L.FeatureGroup.extend({initialize:function(centerLatLng,options){L.Util.setOptions(this,options),this._layers={},this._centerLatLng=centerLatLng,this._loadBars()},getBounds:function(){var map=this._map,radiusX=this.options.radiusX||this.options.radius,radiusY=this.options.radiusY||this.options.radius,deltaX=radiusX*Math.cos(Math.PI/4),deltaY=radiusY*Math.sin(Math.PI/4),point=map.project(this._centerLatLng),swPoint=new L.Point(point.x-deltaX,point.y+deltaY),nePoint=new L.Point(point.x+deltaX,point.y-deltaY),sw=map.unproject(swPoint),ne=map.unproject(nePoint);return new L.LatLngBounds(sw,ne)},setLatLng:function(latlng){return this._centerLatLng=latlng,this.redraw()},getLatLng:function(){return this._centerLatlng},_loadBars:function(){},_highlight:function(options){return options.weight&&(options.weight*=2),options},_unhighlight:function(options){return options.weight&&(options.weight/=2),options},_bindMouseEvents:function(chartElement){var self=this,tooltipOptions=this.options.tooltipOptions;chartElement.on("mouseover",function(e){var newPoint,currentOptions=this.options,key=currentOptions.key,value=currentOptions.value,layerPoint=e.layerPoint,x=layerPoint.x-this._point.x,y=layerPoint.y-this._point.y,iconSize=currentOptions.iconSize,newX=x,newY=y,offset=5;newX=0>x?iconSize.x-x+offset:-x-offset,newY=0>y?iconSize.y-y+offset:-y-offset,newPoint=new L.Point(newX,newY);var legendOptions={},displayText=currentOptions.displayText?currentOptions.displayText(value):value;legendOptions[key]={name:currentOptions.displayName,value:displayText};var icon=new L.LegendIcon(legendOptions,currentOptions,{className:"leaflet-div-icon",iconSize:tooltipOptions?tooltipOptions.iconSize:iconSize,iconAnchor:newPoint});currentOptions.marker=new L.Marker(self._centerLatLng,{icon:icon}),currentOptions=self._highlight(currentOptions),this.initialize(self._centerLatLng,currentOptions),this.redraw(),this.setStyle(currentOptions),self.addLayer(currentOptions.marker)}),chartElement.on("mouseout",function(){var currentOptions=this.options;currentOptions=self._unhighlight(currentOptions),this.initialize(self._centerLatLng,currentOptions),this.redraw(),this.setStyle(currentOptions),self.removeLayer(currentOptions.marker)})},bindPopup:function(content,options){this.eachLayer(function(layer){layer.bindPopup(content,options)})}}),L.BarChartMarker=L.ChartMarker.extend({initialize:function(centerLatLng,options){L.Util.setOptions(this,options),L.ChartMarker.prototype.initialize.call(this,centerLatLng,options)},options:{weight:1,opacity:1,color:"#000",fill:!0,position:{x:0,y:0},width:10,offset:0,iconSize:new L.Point(50,40)},_loadBars:function(){var value,minValue,maxValue;this.options.rotation,this.options.maxDegrees||360;var bar,options=this.options;this.options.radiusX||this.options.radius,this.options.radiusY||this.options.radius;var x,y,chartOption,keys=Object.keys(this.options.data),count=keys.length,width=this.options.width,offset=this.options.offset||0,data=this.options.data,chartOptions=this.options.chartOptions;x=-(width*count+offset*(count-1))/2+width/2,y=0;for(var key in data)value=data[key],chartOption=chartOptions[key],minValue=chartOption.minValue||0,maxValue=chartOption.maxValue||100,options.fillColor=chartOption.fillColor||this.options.fillColor,options.value=value,options.minValue=minValue,options.maxValue=maxValue,options.position={x:x,y:y},options.width=width,options.maxHeight=chartOption.maxHeight||10,options.key=key,options.value=value,options.displayName=chartOption.displayName,options.opacity=this.options.opacity||1,options.fillOpacity=this.options.fillOpacity||.7,options.weight=this.options.weight||1,options.color=chartOption.color||this.options.color,options.displayText=chartOption.displayText,bar=new L.BarMarker(this._centerLatLng,options),this._bindMouseEvents(bar),this.addLayer(bar),x+=width+offset}}),L.RadialBarMarker=L.Path.extend({initialize:function(centerLatLng,options){L.Path.prototype.initialize.call(this,options),this._centerLatLng=centerLatLng},options:{fill:!0,radius:10,rotation:0,numberOfSides:30},setLatLng:function(latlng){return this._centerLatLng=latlng,this.redraw()},projectLatlngs:function(){this._point=this._map.latLngToLayerPoint(this._centerLatLng),this._points=this._getPoints()},getBounds:function(){var map=this._map,radiusX=this.options.radiusX||this.options.radius,radiusY=this.options.radiusY||this.options.radius,deltaX=radiusX*Math.cos(Math.PI/4),deltaY=radiusY*Math.sin(Math.PI/4),point=map.project(this._centerLatLng),swPoint=new L.Point(point.x-deltaX,point.y+deltaY),nePoint=new L.Point(point.x+deltaX,point.y-deltaY),sw=map.unproject(swPoint),ne=map.unproject(nePoint);return new L.LatLngBounds(sw,ne)},getLatLng:function(){return this._centerLatlng},getPathString:function(){return""+new L.SVGPathBuilder(this._points)},_getPoints:function(){var newPoint,innerPoint,angleRadians,angleDelta=this.options.endAngle-this.options.startAngle,angleSize=angleDelta/this.options.numberOfSides,degrees=this.options.endAngle+this.options.rotation,angle=this.options.startAngle+this.options.rotation,points=[],innerPoints=[],radiusX=this.options.radiusX||this.options.radius,radiusY=this.options.radiusY||this.options.radius,toRad=function(number){return number*Math.PI/180};for(this.options.barThickness||points.push(this._point);degrees+1>=angle;)angleRadians=toRad(angle),newPoint=this._getPoint(angleRadians,radiusX,radiusY),points.push(newPoint),this.options.barThickness&&(innerPoint=this._getPoint(angleRadians,radiusX-this.options.barThickness,radiusY-this.options.barThickness),innerPoints.push(innerPoint)),angle+=angleSize;if(this.options.barThickness){innerPoints.reverse();for(var index in innerPoints)points.push(innerPoints[index])}return points},_getPoint:function(angle,radiusX,radiusY){return new L.Point(this._point.x+radiusX*Math.cos(angle),this._point.y+radiusY*Math.sin(angle))}}),L.radialBarMarker=function(centerLatLng,options){return new L.RadialBarMarker(centerLatLng,options)},L.PieChartMarker=L.ChartMarker.extend({initialize:function(centerLatLng,options){L.Util.setOptions(this,options),L.ChartMarker.prototype.initialize.call(this,centerLatLng,options)},options:{weight:1,opacity:1,color:"#000",fill:!0,radius:10,rotation:0,numberOfSides:50,mouseOverExaggeration:1.2,maxDegrees:360,iconSize:new L.Point(50,40)},_highlight:function(options){var oldRadiusX=options.radiusX,oldBarThickness=options.barThickness;return options.oldBarThickness=oldBarThickness,options.radiusX*=options.mouseOverExaggeration,options.radiusY*=options.mouseOverExaggeration,options.barThickness=options.radiusX-oldRadiusX+oldBarThickness,options},_unhighlight:function(options){return options.radiusX/=options.mouseOverExaggeration,options.radiusY/=options.mouseOverExaggeration,options.barThickness=options.oldBarThickness,options},_loadBars:function(){var value,bar,chartOption,key,sum=0,angle=0,percentage=0,maxDegrees=this.options.maxDegrees||360,lastAngle=this.options.rotation,options=this.options,data=this.options.data,chartOptions=this.options.chartOptions,getValue=function(data,key){var value=0;return data[key]&&(value=parseFloat(data[key])),value};for(key in data)value=getValue(data,key),sum+=value;for(key in data)value=parseFloat(data[key]),chartOption=chartOptions[key],percentage=value/sum,angle=percentage*maxDegrees,options.startAngle=lastAngle,options.endAngle=lastAngle+angle,options.fillColor=chartOption.fillColor,options.color=chartOption.color||"#000",options.radiusX=this.options.radiusX||this.options.radius,options.radiusY=this.options.radiusY||this.options.radius,options.rotation=0,options.key=key,options.value=value,options.displayName=chartOption.displayName,options.displayText=chartOption.displayText,bar=new L.RadialBarMarker(this._centerLatLng,options),this._bindMouseEvents(bar),lastAngle=options.endAngle,this.addLayer(bar)}}),L.pieChartMarker=function(centerLatLng,options){return new L.PieChartMarker(centerLatLng,options)},L.CoxcombChartMarker=L.PieChartMarker.extend({initialize:function(centerLatLng,options){L.Util.setOptions(this,options),L.PieChartMarker.prototype.initialize.call(this,centerLatLng,options)},options:{weight:1,opacity:1,color:"#000",fill:!0,radius:10,rotation:0,numberOfSides:50,mouseOverExaggeration:1.2,maxDegrees:360,iconSize:new L.Point(50,40)},_loadBars:function(){var value,bar,chartOption,angle=0,percentage=0,maxDegrees=this.options.maxDegrees||360,lastAngle=this.options.rotation,options=this.options,radiusX=this.options.radiusX||this.options.radius,radiusY=this.options.radiusY||this.options.radius,keys=Object.keys(this.options.data),count=keys.length,data=this.options.data,chartOptions=this.options.chartOptions;angle=maxDegrees/count;for(var key in data)value=parseFloat(data[key]),chartOption=chartOptions[key],maxValue=chartOption.maxValue,percentage=value/maxValue,options.startAngle=lastAngle,options.endAngle=lastAngle+angle,options.fillColor=chartOption.fillColor,options.color=chartOption.color||"#000",options.radiusX=percentage*radiusX,options.radiusY=percentage*radiusY,options.rotation=0,options.key=key,options.value=value,options.displayName=chartOption.displayName,options.displayText=chartOption.displayText,bar=new L.RadialBarMarker(this._centerLatLng,options),this._bindMouseEvents(bar),lastAngle=options.endAngle,this.addLayer(bar)}}),L.coxcombChartMarker=function(centerLatLng,options){return new L.CoxcombChartMarker(centerLatLng,options)},L.RadialBarChartMarker=L.ChartMarker.extend({initialize:function(centerLatLng,options){L.Util.setOptions(this,options),L.ChartMarker.prototype.initialize.call(this,centerLatLng,options)},options:{weight:1,opacity:1,color:"#000",fill:!0,radius:10,rotation:0,numberOfSides:30,offset:2,barThickness:5,maxDegrees:360,iconSize:new L.Point(50,40)},_loadBars:function(){var value,minValue,maxValue,bar,chartOption,angle=this.options.rotation,maxDegrees=this.options.maxDegrees||360,options=this.options,lastRadiusX=this.options.radiusX||this.options.radius,lastRadiusY=this.options.radiusY||this.options.radius,data=this.options.data,chartOptions=this.options.chartOptions,barThickness=this.options.barThickness||4,offset=this.options.offset||2;for(var key in data){value=parseFloat(data[key]),chartOption=chartOptions[key],minValue=chartOption.minValue||0,maxValue=chartOption.maxValue||100;var range=maxValue-minValue;angle=maxDegrees/range*value-maxDegrees/range*minValue,options.startAngle=this.options.rotation,options.endAngle=this.options.rotation+angle,options.fillColor=chartOption.fillColor,options.radiusX=lastRadiusX,options.radiusY=lastRadiusY,options.barThickness=barThickness,options.rotation=0,options.key=key,options.value=value,options.displayName=chartOption.displayName,options.displayText=chartOption.displayText,options.weight=this.options.weight||1,bar=new L.RadialBarMarker(this._centerLatLng,options),this._bindMouseEvents(bar),this.addLayer(bar),lastRadiusX+=barThickness+offset,lastRadiusY+=barThickness+offset}}}),L.radialBarChartMarker=function(centerLatLng,options){return new L.RadialBarChartMarker(centerLatLng,options)},L.StackedRegularPolygonMarker=L.ChartMarker.extend({options:{iconSize:new L.Point(50,40)},initialize:function(centerLatLng,options){L.Util.setOptions(this,options),L.ChartMarker.prototype.initialize.call(this,centerLatLng,options)},_loadBars:function(){var value;this.options.maxDegrees||360;var bar,chartOption,key,lastRadiusX=0,lastRadiusY=0,options=this.options,data=this.options.data,chartOptions=this.options.chartOptions;for(key in data){value=parseFloat(data[key]),chartOption=chartOptions[key],minValue=chartOption.minValue||0,maxValue=chartOption.maxValue||100,minRadius=chartOption.minRadius||0,maxRadius=chartOption.maxRadius||10,options.fillColor=chartOption.fillColor||this.options.fillColor,options.value=value,options.minValue=minValue,options.maxValue=maxValue;var evalFunction=new L.LinearFunction(new L.Point(minValue,minRadius),new L.Point(maxValue,maxRadius)),barThickness=evalFunction.evaluate(value);options.radiusX=lastRadiusX+barThickness,options.radiusY=lastRadiusY+barThickness,options.innerRadiusX=lastRadiusX,options.innerRadiusY=lastRadiusY,options.key=key,options.displayName=chartOption.displayName,options.opacity=this.options.opacity||1,options.fillOpacity=this.options.fillOpacity||.7,options.weight=this.options.weight||1,options.color=chartOption.color||this.options.color,options.displayText=chartOption.displayText,bar=new L.RegularPolygonMarker(this._centerLatLng,options),this._bindMouseEvents(bar),lastRadiusX=options.radiusX,lastRadiusY=options.radiusY,this.addLayer(bar)}}}),L.RadialMeterMarker=L.ChartMarker.extend({initialize:function(centerLatLng,options){L.Util.setOptions(this,options),L.ChartMarker.prototype.initialize.call(this,centerLatLng,options)},options:{weight:1,opacity:1,color:"#000",fill:!0,radius:10,rotation:180,numberOfSides:30,offset:2,barThickness:5,maxDegrees:180,iconSize:new L.Point(50,40)},_loadBars:function(){var value,minValue,maxValue,bar,chartOption,startAngle=this.options.rotation,maxDegrees=this.options.maxDegrees||360,options=this.options,radiusX=this.options.radiusX||this.options.radius,radiusY=this.options.radiusY||this.options.radius,data=this.options.data,chartOptions=this.options.chartOptions,barThickness=this.options.barThickness||4;this.options.offset||2;var displayOptions,lastAngle=startAngle,numSegments=this.options.numSegments||10,angleDelta=maxDegrees/numSegments;for(var key in data){value=parseFloat(data[key]),chartOption=chartOptions[key],displayOptions=this.options.displayOptions?this.options.displayOptions[key]:{},minValue=chartOption.minValue||0,maxValue=chartOption.maxValue||100;for(var range=maxValue-minValue,angle=maxDegrees/range*(value-minValue),endAngle=startAngle+angle,evalFunction=new L.LinearFunction(new L.Point(startAngle,minValue),new L.Point(startAngle+maxDegrees,maxValue));endAngle>lastAngle;){options.startAngle=lastAngle;var delta=Math.min(angleDelta,endAngle-lastAngle);options.endAngle=lastAngle+delta,options.fillColor=chartOption.fillColor,options.radiusX=radiusX,options.radiusY=radiusY,options.barThickness=barThickness,options.rotation=0,options.key=key,options.value=value,options.displayName=chartOption.displayName,options.displayText=chartOption.displayText;var evalValue=evalFunction.evaluate(lastAngle+delta);for(var displayKey in displayOptions)options[displayKey]=displayOptions[displayKey].evaluate?displayOptions[displayKey].evaluate(evalValue):displayOptions[displayKey];bar=new L.RadialBarMarker(this._centerLatLng,options),this._bindMouseEvents(bar),this.addLayer(bar),lastAngle+=delta}}}}),L.Control.Legend=L.Control.extend({options:{position:"bottomright"},onAdd:function(map){var className="leaflet-control-legend",container=L.DomUtil.create("div",className),self=this;return map.on("layeradd",function(e){var layer=e.layer,id=L.Util.stamp(layer);layer.getLegend&&self.addLegend(id,layer.getLegend())}),map.on("layerremove",function(e){var layer=e.layer,id=L.Util.stamp(layer);layer.getLegend&&$(self._container).find("#"+id).remove()}),$(container).on("mouseover mouseout",function(){$(this).toggleClass("larger")}),L.DomEvent.addListener(container,"click",L.DomEvent.stopPropagation).addListener(container,"click",L.DomEvent.preventDefault),container},clear:function(){$(this._container).empty()},toggleSize:function(){$(this._container).toggleClass("larger","slow")},addLegend:function(id,html){var $container=$(this._container),$html=$(html),$existingLegend=$container.find("#"+id);0===$existingLegend.size()?$container.append('<div id="'+id+'">'+html+"</div>"):$existingLegend.find("div.legend").replaceWith($html)}});var L=L||{};L.LocationModes={LATLNG:"latlng",GEOHASH:"geohash",COUNTRY:"country",STATE:"state",GEOJSON:"geojson",CUSTOM:"custom"},L.DataLayer=L.LayerGroup.extend({initialize:function(data,options){L.Util.setOptions(this,options),L.LayerGroup.prototype.initialize.call(this,options),this.addData(data)},_zoomFunction:function(){var map=this._map,self=this,zoom=map.getZoom();if(this.options.maxZoom&&zoom>this.options.maxZoom)this.hiddenLayers=[],this.eachLayer(function(layer){self.hiddenLayers.push(layer),map.removeLayer(layer)});else if(this.hiddenLayers){for(;this.hiddenLayers.length>0;){var layer=this.hiddenLayers.pop();map.addLayer(layer),this.options.backgroundLayer&&layer.bringToBack&&layer.bringToBack()}this.hiddenLayers=null}},onAdd:function(map){L.LayerGroup.prototype.onAdd.call(this,map),map.on("zoomend",this._zoomFunction,this)},onRemove:function(map){L.LayerGroup.prototype.onRemove.call(this,map),map.off("zoomend",this._zoomFunction,this)},getBounds:function(){var bounds;return this.eachLayer(function(layer){layer.getBounds&&(bounds?bounds.extend(layer.getBounds()):bounds=layer.getBounds())}),bounds},options:{recordsField:"features",locationMode:L.LocationModes.LATLNG,latitudeField:"geometry.coordinates.1",longitudeField:"geometry.coordinates.0",displayField:null,displayOptions:null,layerOptions:{numberOfSides:4,radius:10,weight:1,color:"#000"},showLegendTooltips:!0,tooltipOptions:{iconSize:new L.Point(60,50),iconAnchor:new L.Point(-5,50),mouseOverExaggeration:2},setHighlight:function(layerStyle){return layerStyle.weight=layerStyle.weight||1,layerStyle.fillOpacity=layerStyle.fillOpacity||.5,layerStyle.weight*=2,layerStyle.fillOpacity/=1.5,layerStyle},unsetHighlight:function(layerStyle){return layerStyle.weight=layerStyle.weight||1,layerStyle.fillOpacity=layerStyle.fillOpacity||.25,layerStyle.weight/=2,layerStyle.fillOpacity*=1.5,layerStyle}},_getLocationLatLng:function(record){this._getFieldValue(record,this.options.latitudeField),this._getFieldValue(record,this.options.longitudeField);var self=this,getLocation=function(latitudeField,longitudeField){var latitude=self._getFieldValue(record,latitudeField),longitude=self._getFieldValue(record,longitudeField),location=null;if(latitude&&longitude){var latlng=new L.LatLng(latitude,longitude);location={location:latlng,text:[latlng.lat.toFixed(3),latlng.lng.toFixed(3)].join(", "),center:latlng}}return location},location=getLocation(this.options.latitudeField,this.options.longitudeField);if(!location&&this.options.fallbackLocationFields)for(var fallbackLocationFields,index=0;!location&&this.options.fallbackLocationFields.length>index;)fallbackLocationFields=this.options.fallbackLocationFields[index],location=getLocation(fallbackLocationFields.latitudeField,fallbackLocationFields.longitudeField),index++;return location},_getLocationGeohash:function(record){var bounds,geohash=this._getFieldValue(record,this.options.geohashField),locationInfo=decodeGeoHash(geohash);return locationInfo.latitude[2]&&locationInfo.longitude[2]&&(bounds=new L.LatLngBounds(new L.LatLng(locationInfo.latitude[0],locationInfo.longitude[0]),new L.LatLng(locationInfo.latitude[1],locationInfo.longitude[1]))),{location:bounds,text:geohash,center:bounds.getCenter()}},_getLocationChoropleth:function(record,index){var geoJSON,centroid,code=this.options.codeField?this._getFieldValue(record,this.options.codeField):index,codeLookup=L.codeLookup||{},alpha2Lookup=L.alpha2Lookup||{},fips2Lookup=L.fips2Lookup||{},countries=L.countries||{},countryCentroids=L.countryCentroids||{},states=L.states||{},stateCentroids=L.stateCentroids||{},originalCode=code.toUpperCase();code=originalCode,this.options.locationMode===L.LocationModes.COUNTRY?(2===code.length?code=alpha2Lookup[originalCode]||fips2Lookup[originalCode]:3===code.length&&(code=codeLookup[originalCode]||code),code?(geoJSON=countries[code],centroid=countryCentroids[code]):console.log("Code not found: "+originalCode)):this.options.locationMode===L.LocationModes.STATE&&(geoJSON=states[code],centroid=stateCentroids[code]);var geoJSONLayer=new L.GeoJSON(geoJSON),getName=function(geoJSON){var name=null;if(geoJSON&&geoJSON.features)for(var index=0;geoJSON.features.length>index;++index){var feature=geoJSON.features[index];if(feature.properties&&feature.properties.name){name=feature.properties.name;break}}return name};return{location:geoJSONLayer,text:getName(geoJSON)||code,center:centroid}},_getLocationGeoJSON:function(record){var self=this,locationField=this.options.geoJSONField,geoJSON=locationField?this._getFieldValue(record,locationField):record;if(geoJSON){var geoJSONLayer=new L.GeoJSON(geoJSON,{pointToLayer:function(feature,latlng){var location={location:latlng,text:self.options.locationTextField?self._getFieldValue(record,this.options.locationTextField):[latlng.lat.toFixed(3),latlng.lng.toFixed(3)].join(", "),center:latlng};return self.recordToLayer(location,record)}}),center=null;try{center=L.GeometryUtils.loadCentroid(geoJSON)}catch(ex){console.log("Error loading centroid for "+JSON.stringify(geoJSON))}return{location:geoJSONLayer,text:this.options.locationTextField?this._getFieldValue(record,this.options.locationTextField):null,center:center}}},_getLocationCustom:function(record){var locationField=this.options.codeField,fieldValue=this._getFieldValue(record,locationField),context={};if(context[fieldValue]=record,this.options.getLocation){var self=this,callback=function(key,location){self.locationToLayer(location,context[key])};this.options.getLocation(context,locationField,[fieldValue],callback)}},_getLocation:function(record,index){var location;switch(this.options.locationMode){case L.LocationModes.LATLNG:location=this._getLocationLatLng(record);break;case L.LocationModes.GEOHASH:location=this._getLocationGeohash(record);break;case L.LocationModes.COUNTRY:location=this._getLocationChoropleth(record,index);break;case L.LocationModes.STATE:location=this._getLocationChoropleth(record,index);break;case L.LocationModes.GEOJSON:location=this._getLocationGeoJSON(record);break;case L.LocationModes.CUSTOM:this.options.preload||(location=this._getLocationCustom(record))}return location},_processLocation:function(location){var processedLocation=location;return processedLocation=location.center},_getFieldValue:function(record,fieldName){var value=null;if(fieldName){for(var part,searchParts,searchKey,searchValue,testObject,searchPart,testValue,parts=fieldName.split("."),valueField=record,bracketIndex=-1,partIndex=0;parts.length>partIndex;++partIndex)if(part=parts[partIndex],bracketIndex=part.indexOf("["),bracketIndex>-1){searchPart=part.substring(bracketIndex),part=part.substring(0,bracketIndex),searchPart=searchPart.replace("[","").replace("]",""),searchParts=searchPart.split("="),searchKey=searchParts[0],searchValue=searchParts[1],valueField=valueField[part];for(var valueIndex=0;valueField.length>valueIndex;++valueIndex)testObject=valueField[valueIndex],testValue=testObject[searchKey],testValue&&testValue===searchValue&&(valueField=testObject)}else{if(!valueField[part]){valueField=null;break}valueField=valueField[part]}value=valueField}else value=record;return value},_getLayer:function(location,options,record){return location=this._processLocation(location),this._getMarker(location,options,record)},_getMarker:function(location,options){var marker;return location&&(marker=options.numberOfSides>=30?new L.CircleMarker(location,options):new L.RegularPolygonMarker(location,options)),marker},_loadRecords:function(records){var location;for(var recordIndex in records){var record=records[recordIndex];location=this._getLocation(record,recordIndex),this.locationToLayer(location,record)}},_preloadLocations:function(records){var locationField=this.options.codeField,locationValues=[],indexedRecords={};for(var recordIndex in records){var record=records[recordIndex],fieldValue=this._getFieldValue(record,locationField);indexedRecords[fieldValue]=record,locationValues.push(fieldValue)}if(this.options.getLocation){var self=this,callback=function(key,location){self.locationToLayer(location,indexedRecords[key])};this.options.getLocation(indexedRecords,locationField,locationValues,callback)}},addData:function(data){var records=null!==this.options.recordsField&&this.options.recordsField.length>0?this._getFieldValue(data,this.options.recordsField):data;this.options.locationMode===L.LocationModes.CUSTOM&&this.options.preload?this._preloadLocations(records):this._loadRecords(records)},locationToLayer:function(location,record){var layer;layer=this.recordToLayer(location,record),layer&&this.addLayer(layer)},_bindMouseEvents:function(layer,layerOptions,legendDetails){var self=this,options=this.options,setHighlight=options.setHighlight,unsetHighlight=options.unsetHighlight,tooltipOptions=options.tooltipOptions,highlight=function(e){var target=e.target,layerOptions=this.options||target.options,icon=new L.LegendIcon(legendDetails,layerOptions,{className:tooltipOptions.className||"leaflet-div-icon",iconSize:tooltipOptions.iconSize,iconAnchor:tooltipOptions.iconAnchor}),latlng=e.latlng||e.target._latlng,tooltip=new L.Marker(latlng,{icon:icon});self.addLayer(tooltip),self.tooltip&&(self.removeLayer(self.tooltip),self.tooltip=null),self.tooltip=tooltip,setHighlight&&(layerOptions=setHighlight(layerOptions)),target.setStyle&&target.setStyle(layerOptions)},move=function(e){self.tooltip&&self.tooltip.setLatLng(e.latlng)},unhighlight=function(e){self.tooltip&&(self.removeLayer(self.tooltip),self.tooltip=null);var target=e.target,layerOptions=this.options||target.options;unsetHighlight&&(layerOptions=unsetHighlight(layerOptions)),target.setStyle&&target.setStyle(layerOptions)},bindLayerEvents=function(layer){layer.on({mouseover:highlight,mouseout:unhighlight,mousemove:move})},bindEvents=function(layer){layer.eachLayer?layer.eachLayer(function(subLayer){bindEvents(subLayer)}):bindLayerEvents(layer)};bindEvents(layer)},recordToLayer:function(location,record){var layer,layerOptions=L.Util.extend({},this.options.layerOptions),displayOptions=this.options.displayOptions,legendDetails={};if(displayOptions)for(var property in displayOptions){var valueFunction,propertyOptions=displayOptions[property],fieldValue=this._getFieldValue(record,property),displayText=propertyOptions.displayText?propertyOptions.displayText(fieldValue):fieldValue;if(legendDetails[property]={name:propertyOptions.displayName,value:displayText},propertyOptions.styles)layerOptions=L.Util.extend(layerOptions,propertyOptions.styles[fieldValue]),propertyOptions.styles[fieldValue]=layerOptions;else for(var layerProperty in propertyOptions)valueFunction=propertyOptions[layerProperty],layerOptions[layerProperty]=valueFunction.evaluate?valueFunction.evaluate(fieldValue):valueFunction}var includeLayer=!0;return this.options.includeLayer&&(includeLayer=this.options.includeLayer(record)),location&&layerOptions&&includeLayer&&(layerOptions.title=location.text,layer=this._getLayer(location,layerOptions,record),layer&&(this.options.showLegendTooltips&&this._bindMouseEvents(layer,layerOptions,legendDetails),this.options.onEachRecord&&this.options.onEachRecord(layer,record,this))),layer},setCSSProperty:function($element,key,value){var keyMap={fillColor:{property:["background-color"],valueFunction:function(value){return value}},color:{property:["border-color"],valueFunction:function(value){return value}},weight:{property:["border"],valueFunction:function(value){return"solid "+value+"px"}},dashArray:{property:["border-style"],valueFunction:function(value){var style="solid";return value&&(style="dashed"),style}},radius:{property:["height"],valueFunction:function(value){return 2*value+"px"}},fillOpacity:{property:["opacity"],valueFunction:function(value){return value}}},cssProperty=keyMap[key];if(cssProperty){var propertyKey=cssProperty.property;for(var propertyIndex in propertyKey)$element.css(propertyKey[propertyIndex],cssProperty.valueFunction(value))}return $element},getLegend:function(legendOptions){legendOptions=legendOptions||this.options.legendOptions||{};var valueFunction,displayText,displayMin,displayMax,className=legendOptions.className,legendElement='<div class="legend"></div>',$legendElement=$(legendElement),numSegments=legendOptions.numSegments||10,legendWidth=legendOptions.width||100,segmentWidth=legendWidth/numSegments,layerOptions=this.options.layerOptions,displayOptions=this.options.displayOptions;className&&$legendElement.addClass(className),legendOptions.title&&$legendElement.append("<legend>"+legendOptions.title+"</legend>");var defaultFunction=function(value){return value};for(var field in displayOptions){var displayProperties=displayOptions[field],displayName=displayProperties.displayName||field;displayText=displayProperties.displayText;var displayTextFunction=displayText?displayText:defaultFunction,styles=displayProperties.styles;if($legendElement.append('<div class="legend-title">'+displayName+"</div>"),styles){var legend=new L.CategoryLegend(styles);$legendElement.append(legend.generate())}else for(var $legendItems=$('<div class="data-layer-legend"><div class="min-value"></div><div class="scale-bars"></div><div class="max-value"></div></div>'),$minValue=$legendItems.find(".min-value"),$maxValue=$legendItems.find(".max-value"),$scaleBars=$legendItems.find(".scale-bars"),ignoreProperties=["displayName","displayText","minValue","maxValue"],index=0;numSegments>index;++index){var $i=$("<i></i>");L.StyleConverter.applySVGStyle($i,layerOptions);for(var property in displayProperties)if(-1===ignoreProperties.indexOf(property)&&(valueFunction=displayProperties[property],valueFunction&&(valueFunction.getBounds||displayProperties.minValue&&displayProperties.maxValue))){var bounds=valueFunction.getBounds?valueFunction.getBounds():null,minX=bounds?bounds[0].x:displayProperties.minValue,maxX=bounds?bounds[1].x:displayProperties.maxValue,binFunction=new L.LinearFunction(new L.Point(0,minX),new L.Point(numSegments,maxX));displayMin=minX,displayMax=maxX,displayTextFunction&&(displayMin=displayTextFunction(minX),displayMax=displayTextFunction(maxX)),0===index&&($minValue.html(displayMin),$maxValue.html(displayMax));var segmentSize=(maxX-minX)/numSegments,x=binFunction.evaluate(index),value=valueFunction.evaluate?valueFunction.evaluate(x):valueFunction(x);L.StyleConverter.setCSSProperty($i,property,value);var min=segmentSize*index+minX,max=min+segmentSize;displayTextFunction&&valueFunction&&(min=displayTextFunction(min),max=displayTextFunction(max)),$i.attr("title",min+" - "+max)}$i.width(segmentWidth),$scaleBars.append($i)}$legendElement.append($legendItems)}return $legendElement.wrap("<div/>").parent().html()}}),L.MarkerDataLayer=L.DataLayer.extend({initialize:function(data,options){L.DataLayer.prototype.initialize.call(this,data,options)
},options:{recordsField:"features",locationMode:L.LocationModes.LATLNG,latitudeField:"latitude",longitudeField:"longitude",layerOptions:{icon:null}},_getMarker:function(latLng,layerOptions,record){return this.options.setIcon&&(layerOptions.icon=this.options.setIcon(this,record,layerOptions)),new L.Marker(latLng,layerOptions)},getLegend:function(){}}),L.GeohashDataLayer=L.DataLayer.extend({initialize:function(data,options){L.DataLayer.prototype.initialize.call(this,data,options)},options:{recordsField:"features",locationMode:L.LocationModes.GEOHASH,geohashField:"geohash",displayField:null,displayOptions:null,layerOptions:{weight:1,color:"#000"}},_getLayer:function(geohash,layerOptions){return new L.Rectangle(geohash.location,layerOptions)}}),L.ChoroplethDataLayer=L.DataLayer.extend({initialize:function(data,options){L.DataLayer.prototype.initialize.call(this,data,options)},options:{recordsField:"features",locationMode:L.LocationModes.COUNTRY,codeField:"ISO",displayField:null,displayOptions:null,layerOptions:{weight:1,color:"#000"},maxZoom:12,backgroundLayer:!0},_getLayer:function(location,layerOptions,record){return location.location instanceof L.LatLng&&(location.location=this._getMarker(location.location,layerOptions,record)),location.location.setStyle&&location.location.setStyle(layerOptions),location.location}}),L.ChartDataLayer=L.DataLayer.extend({options:{showLegendTooltips:!1},initialize:function(data,options){L.DataLayer.prototype.initialize.call(this,data,options)},_getLayer:function(latLng,layerOptions,record){latLng=this._processLocation(latLng);var chartOptions=this.options.chartOptions;this.options.tooltipOptions;var options={};options=layerOptions,options.data={},options.chartOptions=chartOptions;for(var key in this.options.chartOptions)options.data[key]=this._getFieldValue(record,key);for(var key in this.options.tooltipOptions)options[key]=this.options.tooltipOptions[key];var marker;return latLng&&(marker=this._getMarker(latLng,options)),marker},_getMarker:function(){},getLegend:function(legendOptions){var legend=new L.CategoryLegend(this.options.chartOptions);return legendOptions=legendOptions||this.options.legendOptions,legend.generate(legendOptions)}}),L.BarChartDataLayer=L.ChartDataLayer.extend({initialize:function(data,options){L.ChartDataLayer.prototype.initialize.call(this,data,options)},_getMarker:function(latLng,options){return new L.BarChartMarker(latLng,options)}}),L.RadialBarChartDataLayer=L.ChartDataLayer.extend({initialize:function(data,options){L.ChartDataLayer.prototype.initialize.call(this,data,options)},_getMarker:function(latLng,options){return new L.RadialBarChartMarker(latLng,options)}}),L.PieChartDataLayer=L.ChartDataLayer.extend({initialize:function(data,options){L.ChartDataLayer.prototype.initialize.call(this,data,options)},_getMarker:function(latLng,options){return new L.PieChartMarker(latLng,options)}}),L.CoxcombChartDataLayer=L.ChartDataLayer.extend({initialize:function(data,options){L.ChartDataLayer.prototype.initialize.call(this,data,options)},_getMarker:function(latLng,options){return new L.CoxcombChartMarker(latLng,options)}}),L.StackedRegularPolygonDataLayer=L.ChartDataLayer.extend({initialize:function(data,options){L.ChartDataLayer.prototype.initialize.call(this,data,options)},_getMarker:function(latLng,options){return new L.StackedRegularPolygonMarker(latLng,options)}});var L=L||{};L.LinearFunction=L.Class.extend({initialize:function(minPoint,maxPoint,options){L.Util.setOptions(this,options),this.setRange(minPoint,maxPoint),this._preProcess=this.options.preProcess,this._postProcess=this.options.postProcess},_calculateParameters:function(minPoint,maxPoint){this._slope=(maxPoint.y-minPoint.y)/(maxPoint.x-minPoint.x),this._b=minPoint.y-this._slope*minPoint.x},getBounds:function(){var minX=Math.min(this._minPoint.x,this._maxPoint.x),maxX=Math.max(this._minPoint.x,this._maxPoint.x),minY=Math.min(this._minPoint.y,this._maxPoint.y),maxY=Math.max(this._minPoint.y,this._maxPoint.y);return[new L.Point(minX,minY),new L.Point(maxX,maxY)]},setRange:function(minPoint,maxPoint){return this._minPoint=minPoint,this._maxPoint=maxPoint,maxPoint.x===minPoint.x&&(maxPoint.x=maxPoint.x+1e-7),this._calculateParameters(minPoint,maxPoint),this},setMin:function(point){return this.setRange(point,this._maxPoint),this},setMax:function(point){return this.setRange(this._minPoint,point),this},setPreProcess:function(preProcess){return this._preProcess=preProcess,this},setPostProcess:function(postProcess){return this._postProcess=postProcess,this},evaluate:function(x){var y;return this._preProcess&&(x=this._preProcess(x)),y=Number((this._slope*x).toFixed(6))+Number(this._b.toFixed(6)),this._postProcess&&(y=this._postProcess(y)),y}}),L.RGBRedFunction=L.LinearFunction.extend({options:{outputGreen:0,outputBlue:0},initialize:function(minPoint,maxPoint,options){L.Util.setOptions(this,options);var outputGreen=this.options.outputGreen,outputBlue=this.options.outputBlue,postProcess=function(y){y=y.toFixed(0);var parts=[y,outputGreen,outputBlue];return"rgb("+parts.join(",")+")"};L.LinearFunction.prototype.initialize.call(this,minPoint,maxPoint,{preProcess:this.options.preProcess,postProcess:postProcess})}}),L.RGBBlueFunction=L.LinearFunction.extend({options:{outputRed:0,outputGreen:0},initialize:function(minPoint,maxPoint,options){L.Util.setOptions(this,options);var outputRed=this.options.outputRed,outputGreen=this.options.outputGreen,postProcess=function(y){y=y.toFixed(0);var parts=[outputRed,outputGreen,y];return"rgb("+parts.join(",")+")"};L.LinearFunction.prototype.initialize.call(this,minPoint,maxPoint,{preProcess:this.options.preProcess,postProcess:postProcess})}}),L.RGBGreenFunction=L.LinearFunction.extend({options:{outputRed:0,outputBlue:0},initialize:function(minPoint,maxPoint,options){L.Util.setOptions(this,options);var outputRed=this.options.outputRed,outputBlue=this.options.outputBlue,postProcess=function(y){y=y.toFixed(0);var parts=[outputRed,y,outputBlue];return"rgb("+parts.join(",")+")"};L.LinearFunction.prototype.initialize.call(this,minPoint,maxPoint,{preProcess:this.options.preProcess,postProcess:postProcess})}}),L.RGBColorBlendFunction=L.LinearFunction.extend({initialize:function(minX,maxX,rgbMinColor,rgbMaxColor){var red1=rgbMinColor[0],red2=rgbMaxColor[0],green1=rgbMinColor[1],green2=rgbMaxColor[1],blue1=rgbMinColor[2],blue2=rgbMaxColor[2],postProcess=function(y){return y.toFixed(0)};this._minX=minX,this._maxX=maxX,this._redFunction=new L.LinearFunction(new L.Point(minX,red1),new L.Point(maxX,red2),{postProcess:postProcess}),this._greenFunction=new L.LinearFunction(new L.Point(minX,green1),new L.Point(maxX,green2),{postProcess:postProcess}),this._blueFunction=new L.LinearFunction(new L.Point(minX,blue1),new L.Point(maxX,blue2),{postProcess:postProcess})},getBounds:function(){var redBounds=this._redFunction.getBounds(),greenBounds=this._greenFunction.getBounds(),blueBounds=this._blueFunction.getBounds(),minY=Math.min(redBounds[0].y,greenBounds[0].y,blueBounds[0].y),maxY=Math.max(redBounds[0].y,greenBounds[0].y,blueBounds[0].y);return[new L.Point(redBounds[0].x,minY),new L.Point(redBounds[1].x,maxY)]},evaluate:function(x){return"rgb("+[this._redFunction.evaluate(x),this._greenFunction.evaluate(x),this._blueFunction.evaluate(x)].join(",")+")"}}),L.HSLHueFunction=L.LinearFunction.extend({options:{outputSaturation:"100%",outputLuminosity:"50%"},initialize:function(minPoint,maxPoint,options){L.Util.setOptions(this,options);var outputSaturation=this.options.outputSaturation,outputLuminosity=this.options.outputLuminosity,postProcess=function(y){var parts=[y,outputSaturation,outputLuminosity];return"hsl("+parts.join(",")+")"};L.LinearFunction.prototype.initialize.call(this,minPoint,maxPoint,{preProcess:this.options.preProcess,postProcess:postProcess})}}),L.HSLSaturationFunction=L.LinearFunction.extend({options:{outputHue:0,outputLuminosity:"50%"},initialize:function(minPoint,maxPoint,options){L.Util.setOptions(this,options);var outputHue=this.options.outputHue,outputLuminosity=this.options.outputLuminosity,postProcess=function(y){var parts=[outputHue,(100*y).toFixed(2)+"%",outputLuminosity];return"hsl("+parts.join(",")+")"};L.LinearFunction.prototype.initialize.call(this,minPoint,maxPoint,{preProcess:this.options.preProcess,postProcess:postProcess})}}),L.HSLLuminosityFunction=L.LinearFunction.extend({options:{outputHue:0,outputSaturation:"100%"},initialize:function(minPoint,maxPoint,options){L.Util.setOptions(this,options);var outputHue=this.options.outputHue,outputSaturation=this.options.outputSaturation,postProcess=function(y){var parts=[outputHue,outputSaturation,(100*y).toFixed(2)+"%"];return"hsl("+parts.join(",")+")"};L.LinearFunction.prototype.initialize.call(this,minPoint,maxPoint,{preProcess:this.options.preProcess,postProcess:postProcess})}}),L.PiecewiseFunction=L.LinearFunction.extend({initialize:function(functions,options){L.Util.setOptions(this,options),this._functions=functions;var startPoint,endPoint;startPoint=functions[0].getBounds()[0],endPoint=functions[functions.length-1].getBounds()[1],L.LinearFunction.prototype.initialize.call(this,startPoint,endPoint,{preProcess:this.options.preProcess,postProcess:this.options.postProcess})},_getFunction:function(x){for(var bounds,startPoint,endPoint,currentFunction,found=!1,index=0;this._functions.length>index;++index)if(currentFunction=this._functions[index],bounds=currentFunction.getBounds(),startPoint=bounds[0],endPoint=bounds[1],x>=startPoint.x&&endPoint.x>x){found=!0;break}return found?currentFunction:this._functions[this._functions.length-1]},evaluate:function(x){var currentFunction,y=null;return this._preProcess&&(x=this._preProcess(x)),currentFunction=this._getFunction(x),currentFunction&&(y=currentFunction.evaluate(x),this._postProcess&&(y=this._postProcess(y))),y}}),L.CategoryFunction=L.Class.extend({initialize:function(categoryMap,options){L.Util.setOptions(this,options),this._categoryKeys=Object.keys(categoryMap),this._categoryMap=categoryMap,this._preProcess=this.options.preProcess,this._postProcess=this.options.postProcess},evaluate:function(x){var y;return this._preProcess&&(x=this._preProcess(x)),y=this._categoryMap[x],this._postProcess&&(y=this._postProcess(y)),y},getCategories:function(){return this._categoryKeys}});var L=L||{};L.RegularPolygon=L.Polygon.extend({initialize:function(centerLatLng,options){this._centerLatLng=centerLatLng,L.Util.setOptions(this,options),L.Polygon.prototype.initialize.call(this,this._getLatLngs(),options)},options:{fill:!0,radius:1e3,numberOfSides:4,rotation:0,maxDegrees:360},getLatLng:function(){return this._centerLatLng},setRadius:function(radius){this.options.radius=radius,this._latlngs=this._getLatLngs(),this.redraw()},_getLatLngs:function(){for(var newLatLng,maxDegrees=this.options.maxDegrees||360,angleSize=maxDegrees/Math.max(this.options.numberOfSides,3),degrees=maxDegrees+this.options.rotation,angle=this.options.rotation,latlngs=[];degrees>angle;)newLatLng=this._getPoint(angle),latlngs.push(newLatLng),angle+=angleSize;return latlngs},_getPoint:function(angle){var toRad=function(number){return number*Math.PI/180},toDeg=function(number){return 180*number/Math.PI},angleRadians=toRad(angle),R=6371,M_PER_KM=1e3,angularDistance=this.options.radius/M_PER_KM/R,lat1=toRad(this._centerLatLng.lat),lon1=toRad(this._centerLatLng.lng),lat2=Math.asin(Math.sin(lat1)*Math.cos(angularDistance)+Math.cos(lat1)*Math.sin(angularDistance)*Math.cos(angleRadians)),lon2=lon1+Math.atan2(Math.sin(angleRadians)*Math.sin(angularDistance)*Math.cos(lat1),Math.cos(angularDistance)-Math.sin(lat1)*Math.sin(lat2));return lat2=toDeg(lat2),lon2=toDeg(lon2),new L.LatLng(lat2,lon2)}}),L.regularPolygon=function(centerLatLng,options){return new L.RegularPolygon(centerLatLng,options)},L.RegularPolygonMarker=L.Path.extend({initialize:function(centerLatLng,options){L.Path.prototype.initialize.call(this,options),this._centerLatLng=centerLatLng,this.options.numberOfSides=Math.max(this.options.numberOfSides,3)},options:{fill:!0,radiusX:10,radiusY:10,rotation:0,numberOfSides:3,position:{x:0,y:0},maxDegrees:360},setLatLng:function(latlng){return this._centerLatLng=latlng,this.redraw()},projectLatlngs:function(){this._point=this._map.latLngToLayerPoint(this._centerLatLng),this._points=this._getPoints(),(this.options.innerRadius||this.options.innerRadiusX&&this.options.innerRadiusY)&&(this._innerPoints=this._getPoints(!0).reverse())},getBounds:function(){var map=this._map,radiusX=this.options.radius||this.options.radiusX,radiusY=this.options.radius||this.options.radiusY,deltaX=radiusX*Math.cos(Math.PI/4),deltaY=radiusY*Math.sin(Math.PI/4),point=map.project(this._centerLatLng),swPoint=new L.Point(point.x-deltaX,point.y+deltaY),nePoint=new L.Point(point.x+deltaX,point.y-deltaY),sw=map.unproject(swPoint),ne=map.unproject(nePoint);return new L.LatLngBounds(sw,ne)},getLatLng:function(){return this._latlng},getPathString:function(){return""+new L.SVGPathBuilder(this._points,this._innerPoints)},_getPoints:function(inner){for(var newPoint,angleRadians,maxDegrees=this.options.maxDegrees||360,angleSize=maxDegrees/Math.max(this.options.numberOfSides,3),degrees=maxDegrees+this.options.rotation,angle=this.options.rotation,points=[],radiusX=inner?this.options.innerRadius||this.options.innerRadiusX:this.options.radius||this.options.radiusX,radiusY=inner?this.options.innerRadius||this.options.innerRadiusY:this.options.radius||this.options.radiusY,toRad=function(number){return number*Math.PI/180};degrees>angle;)angleRadians=toRad(angle),newPoint=this._getPoint(angleRadians,radiusX,radiusY),points.push(newPoint),angle+=angleSize;return points},_getPoint:function(angle,radiusX,radiusY){return new L.Point(this._point.x+this.options.position.x+radiusX*Math.cos(angle),this._point.y+this.options.position.y+radiusY*Math.sin(angle))}}),L.regularPolygonMarker=function(centerLatLng,options){return new L.RegularPolygonMarker(centerLatLng,options)},L.StarMarker=L.RegularPolygonMarker.extend({options:{numberOfPoints:5,rotation:-15,maxDegrees:360},_getPoints:function(inner){for(var newPoint,newPointInner,angleRadians,maxDegrees=this.options.maxDegrees||360,angleSize=maxDegrees/this.options.numberOfPoints,degrees=maxDegrees+this.options.rotation,angle=this.options.rotation,points=[],radiusX=inner?this.options.innerRadius||this.options.innerRadiusX:this.options.radius||this.options.radiusX,radiusY=inner?this.options.innerRadius||this.options.innerRadiusY:this.options.radius||this.options.radiusY,toRad=function(number){return number*Math.PI/180};degrees>angle;)angleRadians=toRad(angle),newPoint=this._getPoint(angleRadians,radiusX,radiusY),newPointInner=this._getPoint(angleRadians+toRad(angleSize)/2,radiusX/2,radiusY/2),points.push(newPoint),points.push(newPointInner),angle+=angleSize;return points}}),L.starMarker=function(centerLatLng,options){return new L.StarMarker(centerLatLng,options)},L.TriangleMarker=L.RegularPolygonMarker.extend({options:{numberOfSides:3,rotation:30,radius:5}}),L.triangleMarker=function(centerLatLng,options){return new L.TriangleMarker(centerLatLng,options)},L.DiamondMarker=L.RegularPolygonMarker.extend({options:{numberOfSides:4,radiusX:5,radiusY:10}}),L.diamondMarker=function(centerLatLng,options){return new L.DiamondMarker(centerLatLng,options)},L.SquareMarker=L.RegularPolygonMarker.extend({options:{numberOfSides:4,rotation:45,radius:5}}),L.squareMarker=function(centerLatLng,options){return new L.SquareMarker(centerLatLng,options)},L.PentagonMarker=L.RegularPolygonMarker.extend({options:{numberOfSides:5,rotation:-18,radius:5}}),L.pentagonMarker=function(centerLatLng,options){return new L.PentagonMarker(centerLatLng,options)},L.HexagonMarker=L.RegularPolygonMarker.extend({options:{numberOfSides:6,rotation:30,radius:5}}),L.hexagonMarker=function(centerLatLng,options){return new L.HexagonMarker(centerLatLng,options)},L.OctagonMarker=L.RegularPolygonMarker.extend({options:{numberOfSides:8,rotation:22.5,radius:5}}),L.octagonMarker=function(centerLatLng,options){return new L.OctagonMarker(centerLatLng,options)},Object.keys||(Object.keys=function(){var hasOwnProperty=Object.prototype.hasOwnProperty,hasDontEnumBug=!{toString:null}.propertyIsEnumerable("toString"),dontEnums=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],dontEnumsLength=dontEnums.length;return function(obj){var result,prop,i;if("object"!=typeof obj&&"function"!=typeof obj||null===obj)throw new TypeError("Object.keys called on non-object");result=[];for(prop in obj)hasOwnProperty.call(obj,prop)&&result.push(prop);if(hasDontEnumBug)for(i=0;dontEnumsLength>i;i++)hasOwnProperty.call(obj,dontEnums[i])&&result.push(dontEnums[i]);return result}}());var L=L||{};L.LinearLegend=L.Class.extend({initialize:function(categoryFunction,options){L.Util.setOptions(this,options),this._categoryFunction=categoryFunction},generate:function(){}}),L.CategoryLegend=L.Class.extend({initialize:function(options){L.Util.setOptions(this,options)},generate:function(options){options=options||{};var legend='<div class="legend"></div>',$legend=$(legend),className=options.className,legendOptions=this.options;className&&$legend.addClass(className),options.title&&$legend.append('<div class="legend-title">'+options.title+"</div>");for(var key in legendOptions){categoryOptions=legendOptions[key];var displayName=categoryOptions.displayName||key,$legendElement=$('<div class="data-layer-legend"><div class="legend-box"></div><div class="key">'+displayName+"</div></div>"),$legendBox=$legendElement.find(".legend-box");L.StyleConverter.applySVGStyle($legendBox,categoryOptions),$legend.append($legendElement)}return $legend.wrap("<div/>").parent().html()}}),L.LegendIcon=L.DivIcon.extend({initialize:function(fields,layerOptions,options){var field,html='<div class="legend-content"><div class="title"></div><div class="legend-box"></div><div class="legend-values"></div></div>',$html=$(html),$legendBox=$html.find(".legend-box"),$legendValues=$html.find(".legend-values"),title=layerOptions.title||layerOptions.name;title&&$html.find(".title").text(title);for(var key in fields){field=fields[key];var displayName=field.name||key,displayText=field.value;$legendValues.append('<div class="key">'+displayName+'</div><div class="value">'+displayText+"</div>")}L.StyleConverter.applySVGStyle($legendBox,layerOptions),$legendBox.height(5),html=$html.wrap("<div>").parent().html(),options.html=html,options.className=options.className||"legend-icon",L.DivIcon.prototype.initialize.call(this,options)}}),L.legendIcon=function(fields,layerOptions,options){return new L.LegendIcon(fields,layerOptions,options)},L.GeometryUtils={arrayToMap:function(array,fromKey,toKey){for(var item,from,to,map={},index=0;array.length>index;++index)item=array[index],from=item[fromKey],to=item[toKey],map[from]=to;return map},arrayToMaps:function(array,mapLinks){for(var map,item,from,to,mapLink,fromKey,toKey,maps=[],i=0;mapLinks.length>i;++i)maps.push({});for(var index=0;array.length>index;++index){item=array[index];for(var keyIndex=0;mapLinks.length>keyIndex;++keyIndex)map=maps[keyIndex],mapLink=mapLinks[keyIndex],fromKey=mapLink.from,toKey=mapLink.to,from=item[fromKey],to=item[toKey],map[from]=to}return maps},loadCentroid:function(feature){var centroid,x,y,parser=new jsts.io.GeoJSONParser,jstsFeature=parser.read(feature);if(jstsFeature.getCentroid)centroid=jstsFeature.getCentroid(),x=centroid.coordinate.x,y=centroid.coordinate.y;else if(jstsFeature.features){for(var totalCentroidX=0,totalCentroidY=0,i=0;jstsFeature.features.length>i;++i)centroid=jstsFeature.features[i].geometry.getCentroid(),totalCentroidX+=centroid.coordinate.x,totalCentroidY+=centroid.coordinate.y;x=totalCentroidX/jstsFeature.features.length,y=totalCentroidY/jstsFeature.features.length}else centroid=jstsFeature.geometry.getCentroid(),x=centroid.coordinate.x,y=centroid.coordinate.y;return new L.LatLng(y,x)},loadCentroids:function(dictionary){var feature,centroids={};new jsts.io.GeoJSONParser;for(var key in dictionary)feature=dictionary[key],centroids[key]=L.GeometryUtils.loadCentroid(feature);return centroids}},L.BoundaryService=L.Class.extend({initialize:function(url){this._url=url},loadCentroids:function(data){var feature,jstsFeature,centroid,x,y,centroids={},parser=new jsts.io.GeoJSONParser;for(var key in data){if(feature=data[key],feature.properties&&feature.properties.CENTERLAT&&feature.properties.CENTERLON)y=feature.properties.CENTERLAT,x=feature.properties.CENTERLON;else if(jstsFeature=parser.read(feature),jstsFeature.getCentroid)centroid=jstsFeature.getCentroid(),x=centroid.coordinate.x,y=centroid.coordinate.y;else if(jstsFeature.geometry&&jstsFeature.geometry.getCentroid)centroid=jstsFeature.geometry.getCentroid(),x=centroid.coordinate.x,y=centroid.coordinate.y;else{for(var totalCentroidX=0,totalCentroidY=0,i=0;jstsFeature.features.length>i;++i)centroid=jstsFeature.features[i].geometry.getCentroid(),totalCentroidX+=centroid.coordinate.x,totalCentroidY+=centroid.coordinate.y;x=totalCentroidX/jstsFeature.features.length,y=totalCentroidY/jstsFeature.features.length}centroids[key]=new L.LatLng(y,x)}return centroids},fuse:function(type,dataField,boundaryField,dataToFuse,success,error){var data={dataField:dataField,boundaryField:boundaryField,fuse:"true",data:dataToFuse},self=this;$.ajax({url:this._url+"/"+type,cache:!0,data:data,dataType:"json",type:"POST",success:function(data){if(Object.keys(data).length>0){var centroids=self.loadCentroids(data);success(data,centroids)}},error:error})},getBoundaries:function(type,context,keyField,fieldValues,success,error){var data={},self=this;data[keyField]=fieldValues.join(","),$.ajax({url:this._url+"/"+type,cache:!0,data:data,type:"GET",dataType:"jsonp",context:context,success:function(data){if(Object.keys(data).length>0){var centroids=self.loadCentroids(data);success(context,keyField,data,centroids)}},error:error})}}),L.BoundaryServiceRequester=L.Class.extend({initialize:function(boundaryService,boundaryType,records,codeField,fieldValues,textField){this._boundaryService=boundaryService,this._boundaryType=boundaryType,this._records=records,this._codeField=codeField,this._fieldValues=fieldValues,this._textField=textField},request:function(success,error){var self=this,successCallback=function(context,keyField,data,centroids){var fieldValues=self._fieldValues;for(var key in fieldValues){var fieldValue=fieldValues[key];success(fieldValue,{centroid:centroids[fieldValue],location:new L.GeoJSON(data[fieldValue]),text:context[fieldValue][this._textField]})}};boundaryService.getBoundaries(this._boundaryType,this._records,this._codeField,this._fieldValues,successCallback,error)}}),L.SVGPathBuilder=L.Class.extend({initialize:function(points,innerPoints){this._points=points||[],this._innerPoints=innerPoints||[]},_getPathString:function(points,digits){var pathString="";if(points.length>0){var point=points[0],digits=digits||2;pathString="M"+point.x.toFixed(digits)+","+point.y.toFixed(digits);for(var index=1;points.length>index;index++)point=points[index],pathString+="L"+point.x.toFixed(digits)+","+point.y.toFixed(digits);pathString+="Z"}return pathString},addPoint:function(point,inner){inner?this._innerPoints.push(point):this._points.push(point)},toString:function(){var pathString=this._getPathString(this._points);return this._innerPoints&&(pathString+=this._getPathString(this._innerPoints)),pathString}}),L.StyleConverter={keyMap:{fillColor:{property:["background-color"],valueFunction:function(value){return value}},color:{property:["border-color"],valueFunction:function(value){return value}},weight:{property:["border-width"],valueFunction:function(value){return value+"px"}},stroke:{property:["border-style"],valueFunction:function(value){return value===!0?"solid":"none"}},dashArray:{property:["border-style"],valueFunction:function(value){var style="solid";return value&&(style="dashed"),style}},radius:{property:["height"],valueFunction:function(value){return 2*value+"px"}},fillOpacity:{property:["opacity"],valueFunction:function(value){return value}}},applySVGStyle:function($element,svgStyle,additionalKeys){var keyMap=L.StyleConverter.keyMap;additionalKeys&&(keyMap=L.Util.extend(keyMap,additionalKeys)),$element.css("border-style","solid");for(var property in svgStyle)$element=L.StyleConverter.setCSSProperty($element,property,svgStyle[property],keyMap);return $element},setCSSProperty:function($element,key,value,keyMap){var keyMap=keyMap||L.StyleConverter.keyMap,cssProperty=keyMap[key];if(cssProperty)for(var propertyKey=cssProperty.property,propertyIndex=0;propertyKey.length>propertyIndex;++propertyIndex)$element.css(propertyKey[propertyIndex],cssProperty.valueFunction(value));return $element}},L.StylesBuilder=L.Class.extend({initialize:function(categories,styleFunctionMap){this._categories=categories,this._styleFunctionMap=styleFunctionMap,this._buildStyles()},_buildStyles:function(){for(var category,styleFunction,styleValue,map={},index=0;this._categories.length>index;++index){category=this._categories[index],map[category]={};for(var property in this._styleFunctionMap)styleFunction=this._styleFunctionMap[property],styleValue=styleFunction.evaluate?styleFunction.evaluate(index):"function"==typeof styleFunction?styleFunction(index):styleFunction,map[category][property]=styleValue}this._styleMap=map},getStyles:function(){return this._styleMap}}),L.PaletteBuilder=L.Class.extend({initialize:function(styleFunctionMap){this._styleFunctionMap=styleFunctionMap},generate:function(options){options=options||{};var $paletteElement=$('<div class="palette"></div>'),count=options.count||10,categories=function(count){for(var categoryArray=[],i=0;count>i;++i)categoryArray.push(i);return categoryArray}(count),styleBuilder=new L.StylesBuilder(categories,this._styleFunctionMap),styles=styleBuilder.getStyles();options.className&&$paletteElement.addClass(options.className);for(var styleKey in styles){var $i=$('<i class="palette-element"></i>'),style=styles[styleKey];L.StyleConverter.applySVGStyle($i,style),$paletteElement.append($i)}return $paletteElement.wrap("<div/>").parent().html()}}),L.HTMLUtils={buildTable:function(obj,className,ignoreFields){className=className||"table table-condensed table-striped table-bordered";var html='<table class="'+className+'"><thead><tr><th>Name</th><th>Value</th></tr></thead><tbody></tbody></table>',$html=$(html),$tbody=$html.find("tbody");ignoreFields=ignoreFields||[];for(var property in obj)obj.hasOwnProperty(property)&&-1===$.inArray(ignoreFields,property)&&($.isPlainObject(obj[property])||obj[property]instanceof Array?$tbody.append("<tr><td>"+property+"</td><td>"+L.HTMLUtils.buildTable(obj[property],ignoreFields).wrap("<div/>").parent().html()+"</td></tr>"):$tbody.append("<tr><td>"+property+"</td><td>"+obj[property]+"</td></tr>"));return $html}};